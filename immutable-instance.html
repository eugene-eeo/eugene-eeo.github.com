<html>
<head>
    <style type="text/css">
@import url("code.css");
@import url(http://fonts.googleapis.com/css?family=Open+Sans:400,300,400italic,300italic);
    body { width: 700px; margin: 1em auto; font-size: 18px; font-family: "Open Sans", sans-serif; font-weight: 300; }
    p { font-weight: 300; color: #5E5E5E; }
    b { font-weight: 300; color: #000000; }
    i { font-weight: 300; }
    ul { font:inherit; }
    code {font-size: 14px;}
    h1,h2,h3,h4{font-weight: 300;}
    h1 { font-size: 1.8em; margin: 0 }
    h3 {font-size: 1.5em;}
    h2 { font-size: 1.2em; margin: 0; }
    h4 { border-top: 1px solid #D3D3D3; border-bottom: 1px solid #D3D3D3; padding: 8px; color: #5E5E5E; margin: 0; font-size: 1.1em; }
    a { color: #2A6FB7; text-decoration: none; font-weight: 300; }
    ul, li, table {font:inherit;}
    div.announce { background-color: rgb(245,245,245); border-top: 1px solid #CCCCCC; border-bottom: 1px solid #CCCCCC; margin: 0 -15px; padding:0 15; }
    hr {border:0; background-color:#D3D3D3; height:1px; margin-bottom: 20px;}
    </style>
    <title>Immutable Instance</title>
</head>
<body>
    <h1>Immutable Instance</h1>
    <a href="index.html">&#x2190; Back to Index</a>
    <hr/>
    <p>
        If you are a Python developer and you've wrote or used a couple
        of libraries and frameworks, you'll realize that very often,
        most libraries have what's referred to as an <code>Environment</code>
        object, which is like a single instance which a function derives
        it's methods or behaviour from.
    </p>
    <p>
        Perhaps the most famous of all these examples would be <a href="http://jinja.pocoo.org">Jinja2</a>,
        a template engine which seems to be quite heavy. The <code>Environment</code>
        object is implemented throughout the API, and according to the docs
        is created every time a method/class is invoked.
    </p>
    <p>
        Environments need to be consistent. Because your entire API may
        rely on it, or a particular property of the said Environment,
        which as I said may dictate behaviour. There are often ways to do
        this- some of which is to create a global settings module like
        Django, or maybe use <a href="http://werkzeug.pocoo.org">werkzeug</a>'s
        ImmutableDict data type.
    </p>
    <p>
        For the ImmutableDict data type implementation, you must use the
        werkzeug library- if it is just unpractical for you to install a fully
        featured WSGI toolkit to use a block of code, I think you can get the
        source or write something like that. Anyways, the example:
    </p>
<pre><span class="kwd">from</span> werkzeug.types <span class="kwd">import</span> ImmutableDict

<span class="kwd">class</span> Environment(<span class="kwd">object</span>):
    <span class="kwd">def</span> setup(self):
        self.__dict__ = ImmutableDict(**self.__dict__)
</pre>
    <p>
        In the rare events that you do not want any of those implementations,
        you can consider the following snippet that I made for playing
        around with (note that it aesthetically resembles the Jinja2 Environment
        object):
    </p>
<pre><span class="kwd">class</span> EnvironmentError(<span class="kwd">Exception</span>):
    <span class="kwd">pass</span>


<span class="kwd">class</span> Environment(<span class="kwd">object</span>):
    <span class="kwd">def</span> setup(self):
        self._write = <span class="imp">True</span>

    <span class="kwd">def</span> lock(self):
        self._write = <span class="imp">False</span>

    @<span class="kwd">property</span>
    <span class="kwd">def</span> __raiseError__(self):
        <span class="kwd">raise</span> EnvironmentError(<span class="str">"Cannot mutate locked environment."</span>)

    <span class="kwd">def</span> <span class="kwd">__delattr__</span>(self, val):
        <span class="kwd">if</span> self._write:
            <span class="kwd">del</span> self.__dict__[val]
        <span class="kwd">else</span>:
            self.__raiseError__

    <span class="kwd">def</span> <span class="kwd">__setattr__</span>(self, val, key):
        <span class="kwd">if</span> "_write" not in self.<span class="kwd">__dict__</span>:
            self.__dict__[val] = key

        <span class="kwd">if self._write</span>:
            self.__dict__[val] = key
        <span class="kwd">else</span>:
            self.__raiseError__

    <span class="kwd">def</span> <span class="kwd">__init__</span>(self, loader, dump_path):
        self.setup()

        self.loader = loader
        self.dump_path = dump_path

        <span class="cmt"># lock the environment</span>
        self.lock()
</pre>
    <hr/>
    Authored on <code>Wed Aug 21 10:22:40 2013</code>
</body>
</html>
